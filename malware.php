<?php 

require_once 'login.php';
$connection=new mysqli($hn,$un,$pw,$db);
//if any errors
if (!$connection) {
	echo "Could not connect";
}

echo <<<_END
<html><head><title>Malware Check</title></head><body>
<form method="post" action="malware.php" enctype="multipart/form-data">
<pre>
User File Upload: <input type="file" name="user">
<input type="submit" name="userfile" value = "Upload">
</pre>
</form>
_END;
echo "</body></html>";



if (isset($_FILES)){
	
	$files=$_FILES['user']['name'];
	if (!empty($files)) {
	$files=preg_replace("/[^A-Za-z0-9.]/", "", $files); //sanitizing
	

		

//readding the content from the uploaded file and sanitizing
	$file=fopen($_FILES['user']['tmp_name'], "r") or die ("No file");
	$fileContents=stream_get_contents($file);
	fclose($file);
	sanitizeMySQL($connection,$fileContents);
	

	
//selecting a table for malware
$query = "SELECT * FROM malware";
$result = $connection->query($query);
//if any errors
if (!$result){
	die ("Sorry");
}
//checking if there is a virus
 $rows = $result->num_rows;
 $isVirus = false;
    for ($i = 0; $i < $rows; ++$i) {
    	 $result->data_seek($i);
    	 $row = $result->fetch_array(MYSQLI_ASSOC);
    	 $pos = strpos($fileContents, $row[Contents]);

    	 if ($pos !== false) {
    	 	 echo "!!!ALERT!!!</br>The file contains VIRUS"."</br>";
    	 	  $isVirus = true;
    	 	   break;
    	 }

    }
    if (!$isVirus){
    echo "Uploaded File is VIRUS FREE</br>";}
}
}




//sanitizers
function mysql_fix_string($connection, $string){
	if (get_magic_quotes_gpc()) $string = stripslashes($string);
	return $connection->real_escape_string($string);
}

function sanitizeString($var) {
	$var = stripslashes($var);
	$var = strip_tags($var);
	$var = htmlentities($var);
	return $var;

}
function sanitizeMySQL($connection, $var) {
	$var = $connection->real_escape_string($var);
	$var = sanitizeString($var);
	return $var;
}

$result->close();
$connection->close();
 ?>