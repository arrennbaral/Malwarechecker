<?php 
require_once 'login.php';
$connection=new mysqli($hn,$un,$pw,$db);
//if any errors
if (!$connection) {
	die( "Could not connect");
}
//creating a table for admin credentials
createTable($connection);
$username='aaa';
$password='bbb';
$salt1='123!';
$salt2='pg$#';
$token=hash("ripemd128", "$salt1$password$salt2");   //hashing the password with salt
//inserting credentials into the table malware
$query="INSERT INTO users VALUES('$username','$token','$salt1','$salt2') ";
$result=$connection->query($query);
//if any errors
if(!result) {die ("Cant connect");}


echo <<<_END
<html><head><title>ADMIN PAGE</title></head><body>
<form method="post" action="admin.php" enctype="multipart/form-data">
<pre>
Name of a malware:<input type="text" name="virus">
Admin File Upload: <input type="file" name="admin">
<input type="submit" name="adminfile" value = "Upload">

</pre>

</form>
_END;
echo "</body></html>";
//authentication for admin
   if (isset($_SERVER['PHP_AUTH_USER']) && isset($_SERVER['PHP_AUTH_PW'])) {
//sanitizing admin's credentials
   	$un_temp=mysql_fix_string($connection, $_SERVER['PHP_AUTH_USER']);
   	$pw_temp=mysql_fix_string($connection, $_SERVER['PHP_AUTH_PW']);
//querying
   	$query="SELECT * FROM users WHERE username='$un_temp'";
   	$result=$connection->query($query);
   	//if any errors
   	if(!result) {
   		die ("Cant connect");
   	}

   	elseif ($result->num_rows) {
   		//authenticating with the credentials
   		$row = $result->fetch_array(MYSQLI_NUM);
   		$result->close();
   		$salt1='123!';
		  $salt2='pg$#';
   		$token = hash('ripemd128', "$salt1$pw_temp$salt2");
   		if ($token == $row[1]) {
   			 echo "Welcome admin $row[0] </br>";
   		}

   		else {die("Invalid Username or Password </br>");}
   			   	}

   		else die("Invalid Username or Password </br>");

   			  
   		} else {
        header("WWW-Authenticate: Basic realm=\"Restricted Section\"");
        header("HTTP\ 1.0 401 Unauthorized");
        die("Please enter your username and password </br>");
    }
 //calling malware_upload function to insert malware in the db
malware_upload($connection);

function malware_upload($connection){
	//creating table for name of a malware and malware contents 20bytes
TableAdmin($connection);
//accessing the file and reading the content
    $file=fopen($_FILES['admin']['tmp_name'], "r") or die ("No file");
    $fileContents=fread($file,20);
    fclose($file);//sanitizing the malware content
    sanitizeMySQL($connection,$fileContents);
    //getting name of the malware and sanitizing as well
	$name = mysql_fix_string($connection, $_FILES['admin']['name']);
  	$VirusName = mysql_fix_string($connection, $_POST['virus']);


//reading 20 bytes
   if ( strlen($fileContents) < 20) {
      echo "WARNING: File needs to contain at least a minimum of 20 bytes.</br>";
      exit();
                }

  if (isset($name)&&isset($_POST['adminfile'])) {

    if((!empty($VirusName))&&(!empty($file))) {
    	$stmt = $connection->prepare("INSERT INTO malware VALUES (?,?)");
    	$stmt->bind_param('ss',$VirusName,$fileContents);
   		$stmt->execute();
   		printf("Malware succesfully inserted.\n",$stmt->affected_rows);
    if(!$stmt){
     die("Failed to insert </br>");
          }

    

}

  }

}



//sanitizers
function createTable($connection){
	$query="SELECT * FROM users";
	$result=$connection->query($query);
if (empty($result)){
$query="CREATE TABLE users (
	username VARCHAR (64),
	h_pw VARCHAR(64),
	salt1 VARCHAR(64),
	salt2 VARCHAR(64))";

	$result=$connection->query($query);	
}
	if(!$result){
	die ("oopsy");
} 
}
function TableAdmin($connection){
  $query="SELECT * FROM malware";
  $result=$connection->query($query);
if (empty($result)){
$query="CREATE TABLE malware (
  Malware VARCHAR (64),
  Contents VARCHAR(64))";

  $result=$connection->query($query); 
}
  if(!$result){
  die ("oopsy");
} 
}



function sanitizeString($var) {
	$var = stripslashes($var);
	$var = strip_tags($var);
	$var = htmlentities($var);
	return $var;
}

function sanitizeMySQL($connection, $var) {
	$var = $connection->real_escape_string($var);
	$var = sanitizeString($var);
	return $var;
}
function mysql_fix_string($connection, $string)
{
    if (get_magic_quotes_gpc()) $string = stripslashes($string);
    return $connection->real_escape_string($string);
}
$stmt->close();
$result->close();
$connection->close();
?>